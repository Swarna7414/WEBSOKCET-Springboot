<!DOCTYPE html>
<html>
<head>
    <title>Public Chat Room</title>


    <script src="/js/stomp.min.js"></script>


    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>

</head>
<body>

<h2>Public Chat Room</h2>

<div>
    <label>
        Your Name:
        <input id="nameInput" type="text" placeholder="Enter your name">
    </label>
</div>

<br>

<div>
    <input id="messageInput" type="text" placeholder="Type your message..." style="width:300px;">
    <button onclick="sendMessage()">Send</button>
</div>

<hr>

<ul id="messages" style="list-style: none; padding: 0;"></ul>

<script>
    console.log("Stomp is:", typeof Stomp); // Debug check

    let stompClient = null;

    // Connect to /ws WebSocket endpoint
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);

    // Connect STOMP client
    stompClient.connect({}, function () {

        console.log("Connected to WebSocket");

        // Subscribe to the public chat topic
        stompClient.subscribe('/topic/public', function (message) {

            const chat = JSON.parse(message.body);
            if (!chat) return;

            let li = document.createElement("li");
            li.innerHTML = `<b>${chat.sender}</b> [${chat.timestamp}] : ${chat.content}`;
            document.getElementById("messages").appendChild(li);
        });

    });

    // Send message function
    function sendMessage() {

        // Ensure WebSocket is connected
        if (!stompClient || !stompClient.connected) {
            alert("WebSocket not connected yet!");
            return;
        }

        const name = document.getElementById("nameInput").value.trim() || "Anonymous";
        const content = document.getElementById("messageInput").value.trim();

        if (content === "") return; // Do not send empty messages

        const chatMessage = {
            sender: name,
            content: content
        };

        // Send message to backend
        stompClient.send("/app/chat.send", {}, JSON.stringify(chatMessage));

        document.getElementById("messageInput").value = "";
    }
</script>

</body>
</html>
