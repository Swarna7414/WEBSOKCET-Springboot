<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Chat – Broadcast + DM + Online Users</title>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="/js/stomp.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #messages, #errors, #privateMessages, #onlineUsers {
            list-style: none;
            padding-left: 0;
        }
        #messages li { margin-bottom: 4px; }
        #privateMessages li { margin-bottom: 4px; color: darkgreen; }
        #errors li { margin-bottom: 4px; color: red; }
        #onlineUsers li { margin-bottom: 2px; color: blue; }
        .row { margin-bottom: 10px; }
        fieldset { margin-top: 15px; }
    </style>
</head>
<body>

<h2>Spring WebSocket – Broadcast + DM + Online Users</h2>

<div class="row">
    <label>Your username: </label>
    <input type="text" id="currentUser" value="Harshith">
    <button onclick="reconnect()">Set / Reconnect</button>
</div>

<h3>Online Users</h3>
<ul id="onlineUsers"></ul>

<fieldset>
    <legend>Broadcast Chat (/topic/messages)</legend>
    <div class="row">
        <label>Message: </label>
        <input type="text" id="content" style="width: 250px;">
        <button onclick="sendBroadcast()">Send Broadcast</button>
    </div>
    <ul id="messages"></ul>
</fieldset>

<fieldset>
    <legend>Direct Message (/app/private-message)</legend>
    <div class="row">
        <label>Send to (recipient): </label>
        <input type="text" id="recipient" placeholder="Enter username">
    </div>
    <div class="row">
        <label>Message: </label>
        <input type="text" id="privateContent" style="width: 250px;">
        <button onclick="sendPrivate()">Send DM</button>
    </div>
    <h4>Private messages to YOU</h4>
    <ul id="privateMessages"></ul>
</fieldset>

<h3>Errors from Server</h3>
<ul id="errors"></ul>

<script>
    let stompClient = null;
    let currentUser = null;

    function connect(username) {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // disable STOMP logs

        // send username as header to server
        stompClient.connect({ username: username }, function (frame) {
            console.log('Connected: ' + frame);
            currentUser = username;

            // 1) Broadcast messages
            stompClient.subscribe('/topic/messages', function (messageFrame) {
                const body = JSON.parse(messageFrame.body);
                showBroadcast(body);
            });

            // 2) Errors
            stompClient.subscribe('/queue/errors', function (errorFrame) {
                const body = JSON.parse(errorFrame.body);
                showError(body);
            });

            // 3) Private messages for THIS user
            const privateDestination = '/user/' + currentUser + '/queue/messages';
            stompClient.subscribe(privateDestination, function (messageFrame) {
                const body = JSON.parse(messageFrame.body);
                showPrivate(body);
            });

            // 4) Online users list
            stompClient.subscribe('/topic/online-users', function (frame) {
                const users = JSON.parse(frame.body); // array of strings
                showOnlineUsers(users);
            });

        }, function (error) {
            console.error('STOMP error: ', error);
            alert('Lost connection to server');
        });
    }

    function reconnect() {
        const usernameInput = document.getElementById('currentUser').value.trim();
        if (!usernameInput) {
            alert('Please enter a username first.');
            return;
        }
        if (stompClient !== null) {
            stompClient.disconnect(() => {
                console.log('Disconnected. Reconnecting as ' + usernameInput);
                connect(usernameInput);
            });
        } else {
            connect(usernameInput);
        }
    }

    function sendBroadcast() {
        const content = document.getElementById('content').value;
        const message = {
            sender: currentUser,
            content: content,
            type: "CHAT"
        };
        stompClient.send("/app/chat.send", {}, JSON.stringify(message));
        document.getElementById('content').value = '';
    }

    function sendPrivate() {
        const recipient = document.getElementById('recipient').value.trim();
        const content = document.getElementById('privateContent').value;

        const msg = {
            sender: currentUser,
            recipient: recipient,
            content: content
        };

        stompClient.send("/app/private-message", {}, JSON.stringify(msg));
        document.getElementById('privateContent').value = '';
    }

    function showBroadcast(msg) {
        const li = document.createElement('li');
        const time = msg.timestamp ? msg.timestamp : '';
        li.innerText = `[GLOBAL] ${time}  ${msg.sender}: ${msg.content}`;
        document.getElementById('messages').appendChild(li);
    }

    function showPrivate(msg) {
        const li = document.createElement('li');
        const time = msg.timestamp ? msg.timestamp : '';
        li.innerText = `[DM from ${msg.sender}] ${time}  ${msg.content}`;
        document.getElementById('privateMessages').appendChild(li);
    }

    function showError(err) {
        const li = document.createElement('li');
        li.innerText = err.error;
        document.getElementById('errors').appendChild(li);
    }

    function showOnlineUsers(users) {
        const list = document.getElementById('onlineUsers');
        list.innerHTML = '';
        users.forEach(u => {
            const li = document.createElement('li');
            li.innerText = u;
            list.appendChild(li);
        });
    }

    window.addEventListener('load', function () {
        reconnect();
    });
</script>

</body>
</html>
