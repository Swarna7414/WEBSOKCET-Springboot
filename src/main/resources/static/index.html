<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Spring Boot WebSocket Chat</title>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        h2, h3, h4 {
            margin: 0 0 10px;
        }

        #login-box, #chat-box {
            background: #ffffff;
            border-radius: 6px;
            padding: 15px;
            max-width: 700px;
            margin: 0 auto 15px auto;
            box-shadow: 0 0 6px rgba(0,0,0,0.08);
        }

        #chat-box {
            display: none;
        }

        .row {
            margin-bottom: 10px;
        }

        label {
            display: inline-block;
            min-width: 110px;
        }

        input[type="text"] {
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            width: 200px;
        }

        button {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            background: #007bff;
            color: #fff;
            cursor: pointer;
            margin-left: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        #error-area {
            color: #b00020;
            font-weight: bold;
            margin-bottom: 8px;
            min-height: 18px;
        }

        .chat-section {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            background: #fafafa;
            border: 1px solid #e0e0e0;
        }

        .messages {
            height: 160px;
            border: 1px solid #ddd;
            padding: 6px;
            margin-bottom: 8px;
            background: #ffffff;
            overflow-y: auto;
            font-size: 14px;
        }

        .msg-line {
            margin: 2px 0;
        }

        .msg-line span.sender {
            font-weight: bold;
        }

        .msg-line span.private-tag {
            color: #007bff;
            font-size: 12px;
            margin-right: 4px;
        }

        .small-input {
            width: 140px;
        }

        .full-width {
            width: calc(100% - 90px);
        }

        .inline {
            display: inline-block;
            vertical-align: middle;
        }
    </style>
</head>
<body>

<h2 style="text-align: center;">Spring Boot WebSocket Chat Demo</h2>

<!-- LOGIN BOX -->
<div id="login-box">
    <h3>Join Chat</h3>
    <div class="row">
        <label for="username">Your username:</label>
        <input type="text" id="username" />
        <button id="btn-connect">Connect</button>
    </div>
</div>

<!-- CHAT BOX -->
<div id="chat-box">
    <h3>Welcome, <span id="current-user"></span></h3>

    <!-- ERROR DISPLAY -->
    <div id="error-area"></div>

    <!-- PUBLIC CHAT -->
    <div class="chat-section">
        <h4>Public Chat</h4>
        <div id="public-messages" class="messages"></div>
        <div>
            <input
                    type="text"
                    id="public-input"
                    class="full-width inline"
                    placeholder="Type a public message and press Send" />
            <button id="btn-public-send">Send</button>
        </div>
    </div>

    <!-- PRIVATE CHAT -->
    <div class="chat-section">
        <h4>Private Chat</h4>

        <div class="row">
            <label for="receiver">Send to user:</label>
            <input
                    type="text"
                    id="receiver"
                    class="small-input"
                    placeholder="receiver username" />
        </div>

        <div id="private-messages" class="messages"></div>

        <div>
            <input
                    type="text"
                    id="private-input"
                    class="full-width inline"
                    placeholder="Type a private message and press Send" />
            <button id="btn-private-send">Send</button>
        </div>
    </div>
</div>

<!-- ======= SCRIPTS ======= -->
<!-- SockJS from CDN -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>

<!-- Your local stomp.min.js -->
<!-- If file is at: src/main/resources/static/js/stomp.min.js -->
<script src="/js/stomp.min.js"></script>
<!-- If you put it directly under /static, use: <script src="/stomp.min.js"></script> -->

<script>
    let stompClient = null;
    let currentUser = null;

    const loginBox        = document.getElementById('login-box');
    const chatBox         = document.getElementById('chat-box');
    const currentUserSpan = document.getElementById('current-user');

    const publicMessages  = document.getElementById('public-messages');
    const privateMessages = document.getElementById('private-messages');
    const errorArea       = document.getElementById('error-area');

    const usernameInput   = document.getElementById('username');
    const publicInput     = document.getElementById('public-input');
    const privateInput    = document.getElementById('private-input');
    const receiverInput   = document.getElementById('receiver');

    const btnConnect      = document.getElementById('btn-connect');
    const btnPublicSend   = document.getElementById('btn-public-send');
    const btnPrivateSend  = document.getElementById('btn-private-send');

    // ---------- CONNECT ----------
    btnConnect.addEventListener('click', connect);

    function connect() {
        const username = usernameInput.value.trim();
        if (!username) {
            showError('Please enter a username.');
            return;
        }

        currentUser = username;

        const socket = new SockJS('/ws');
        // Stomp is provided by your stomp.min.js
        stompClient = Stomp.over(socket);

        // Optional: disable debug logs
        stompClient.debug = null;

        stompClient.connect({}, onConnected, onError);
    }

    function onConnected() {
        loginBox.style.display = 'none';
        chatBox.style.display  = 'block';
        currentUserSpan.textContent = currentUser;
        clearError();

        // ---- SUBSCRIPTIONS ----

        // 1. Public messages
        stompClient.subscribe('/topic/public', (frame) => {
            const msg = JSON.parse(frame.body);
            appendPublicMessage(msg.sender, msg.content);
        });

        // 2. Private messages for THIS USER
        //    Backend must send to: /queue/private.{receiverUsername}
        stompClient.subscribe('/queue/private.' + currentUser, (frame) => {
            const msg = JSON.parse(frame.body);
            appendPrivateMessage(msg.sender, msg.content);
        });

        // 3. Error messages (optional)
        //    If you broadcast errors to /topic/errors, they will appear here.
        stompClient.subscribe('/topic/errors', (frame) => {
            try {
                const err = JSON.parse(frame.body);
                showError(err.message || frame.body);
            } catch (e) {
                showError(frame.body);
            }
        });
    }

    function onError(error) {
        showError('Could not connect to WebSocket server. Please refresh and try again.');
        console.error(error);
    }

    // ---------- SEND MESSAGES ----------

    btnPublicSend.addEventListener('click', sendPublicMessage);
    btnPrivateSend.addEventListener('click', sendPrivateMessage);

    // Enter key support
    publicInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') sendPublicMessage();
    });

    privateInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') sendPrivateMessage();
    });

    function sendPublicMessage() {
        const content = publicInput.value.trim();
        if (!content || !stompClient || !stompClient.connected) {
            return;
        }

        const message = {
            sender: currentUser,
            content: content,
            type: 'CHAT'
        };

        stompClient.send('/app/chat.public', {}, JSON.stringify(message));
        publicInput.value = '';
    }

    function sendPrivateMessage() {
        const content  = privateInput.value.trim();
        const receiver = receiverInput.value.trim();

        if (!content || !receiver || !stompClient || !stompClient.connected) {
            return;
        }

        const message = {
            sender: currentUser,
            receiver: receiver,
            content: content,
            type: 'CHAT'
        };

        // Backend mapping: @MessageMapping("/chat.private")
        stompClient.send('/app/chat.private', {}, JSON.stringify(message));
        privateInput.value = '';
    }

    // ---------- UI HELPERS ----------

    function appendPublicMessage(sender, text) {
        const p = document.createElement('p');
        p.className = 'msg-line';
        p.innerHTML = `<span class="sender">${sender}</span>: ${escapeHtml(text)}`;
        publicMessages.appendChild(p);
        publicMessages.scrollTop = publicMessages.scrollHeight;
    }

    function appendPrivateMessage(sender, text) {
        const p = document.createElement('p');
        p.className = 'msg-line';
        p.innerHTML =
            `<span class="private-tag">[PRIVATE]</span>` +
            `<span class="sender">${sender}</span>: ${escapeHtml(text)}`;
        privateMessages.appendChild(p);
        privateMessages.scrollTop = privateMessages.scrollHeight;
    }

    function showError(msg) {
        errorArea.textContent = msg || '';
        if (msg) {
            // clear after 4 seconds
            setTimeout(() => {
                if (errorArea.textContent === msg) {
                    errorArea.textContent = '';
                }
            }, 4000);
        }
    }

    function clearError() {
        errorArea.textContent = '';
    }

    // Simple HTML escaping to avoid issues when printing text
    function escapeHtml(str) {
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }
</script>

</body>
</html>
